{% extends "base.html" %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª - Ù†Ø¸Ø§Ù… POS{% endblock %}
{% block page_title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª{% endblock %}

{% block extra_css %}
<style>
    .returns-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .search-section {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex: 1;
        max-width: 500px;
    }

    .search-input {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        border: 2px solid #e9ecef;
        font-size: 1rem;
    }

    .returns-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .table {
        margin: 0;
    }

    .table thead th {
        background: var(--warning-color);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f3f4;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .return-id {
        font-weight: 600;
        color: var(--warning-color);
    }

    .return-type-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .return-sale {
        background: #d1ecf1;
        color: #0c5460;
    }

    .return-purchase {
        background: #d4edda;
        color: #155724;
    }

    .amount-display {
        font-weight: 600;
        color: var(--warning-color);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 8px;
    }

    .add-return-btn {
        background: linear-gradient(45deg, var(--warning-color), #ffc107);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .add-return-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(255, 193, 7, 0.3);
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--warning-color) 0%, #ffc107 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .modal-content {
        border-radius: 15px;
        border: none;
    }

    .modal-header {
        background: var(--warning-color);
        color: white;
        border-radius: 15px 15px 0 0;
    }

    .form-control {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--warning-color);
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }

    @media (max-width: 768px) {
        .returns-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .search-section {
            max-width: none;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }

        .stats-cards {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-cards">
    <div class="stat-card">
        <div class="stat-value" id="todayReturns">0</div>
        <div class="stat-label">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="monthReturns">0</div>
        <div class="stat-label">Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalReturns">0</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="returnRate">0%</div>
        <div class="stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</div>
    </div>
</div>

<div class="returns-header">
    <div class="search-section">
        <input type="text" class="form-control search-input" id="returnsSearch" 
               placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª...">
        <button class="btn btn-outline-secondary" onclick="loadReturns()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    
    <button class="btn add-return-btn" onclick="showAddReturnModal()">
        <i class="fas fa-undo"></i>
        Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯
    </button>
</div>

<div class="returns-table">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="returnsTableBody">
                <!-- Returns will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add Return Modal -->
<div class="modal fade" id="addReturnModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="returnForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ *</label>
                                <select class="form-control" id="returnType" required onchange="loadInvoices()">
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</option>
                                    <option value="sale">Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                                    <option value="purchase">Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                                    <option value="exchange">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬</option>
                                    <option value="refund">Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© *</label>
                                <select class="form-control" id="originalInvoice" required onchange="loadInvoiceDetails()">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="invoiceDetails" style="display: none;">
                        <h6>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h6>
                        <div id="invoiceInfo"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</label>
                        <div id="returnItems">
                            <!-- Return items will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ *</label>
                                <select class="form-control" id="returnReason" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨</option>
                                    <option value="defective">Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠØ¨</option>
                                    <option value="wrong_item">Ù…Ù†ØªØ¬ Ø®Ø§Ø·Ø¦</option>
                                    <option value="customer_request">Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                                    <option value="expired">Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
                                    <option value="other">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±ØªØ¬Ø¹</label>
                                <input type="number" class="form-control" id="returnAmount" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea class="form-control" id="returnNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-warning" onclick="saveReturn()">Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let returns = [];
    let invoices = [];
    let selectedInvoice = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadReturns();
        loadStats();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('returnsSearch').addEventListener('input', filterReturns);
    }

    async function loadReturns() {
        try {
            const response = await fetch('/api/returns');
            if (response.ok) {
                returns = await response.json();
            } else {
                returns = [];
            }
            displayReturns();
        } catch (error) {
            console.error('Error loading returns:', error);
            returns = [];
            displayReturns();
        }
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/returns/stats');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('todayReturns').textContent = stats.today_returns || '0';
                document.getElementById('monthReturns').textContent = stats.month_returns || '0';
                document.getElementById('totalReturns').textContent = stats.total_returns || '0';
                document.getElementById('returnRate').textContent = (stats.return_rate || 0) + '%';
            } else {
                // Show default stats
                document.getElementById('todayReturns').textContent = '0';
                document.getElementById('monthReturns').textContent = '0';
                document.getElementById('totalReturns').textContent = '0';
                document.getElementById('returnRate').textContent = '0%';
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    function displayReturns(filteredReturns = null) {
        const returnsToShow = filteredReturns || returns;
        const tbody = document.getElementById('returnsTableBody');
        
        tbody.innerHTML = '';
        
        if (returnsToShow.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-undo fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        returnsToShow.forEach(returnItem => {
            const date = new Date(returnItem.created_at).toLocaleDateString('ar-EG');
            const time = new Date(returnItem.created_at).toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <span class="return-id">#${returnItem.id}</span>
                </td>
                <td>
                    <span class="return-type-badge ${returnItem.type === 'sale' ? 'return-sale' : 'return-purchase'}">
                        ${returnItem.type === 'sale' ? 'Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª' : 'Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª'}
                    </span>
                </td>
                <td>#${returnItem.original_invoice_id}</td>
                <td>${returnItem.customer_supplier_name}</td>
                <td class="amount-display">${returnItem.amount.toFixed(2)} Ø¬.Ù…</td>
                <td>${returnItem.reason}</td>
                <td>
                    <div>${date}</div>
                    <small class="text-muted">${time}</small>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReturn(${returnItem.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="printReturn(${returnItem.id})">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function filterReturns() {
        const searchTerm = document.getElementById('returnsSearch').value.toLowerCase();
        const filtered = returns.filter(returnItem => 
            returnItem.id.toString().includes(searchTerm) ||
            returnItem.original_invoice_id.toString().includes(searchTerm) ||
            returnItem.customer_supplier_name.toLowerCase().includes(searchTerm) ||
            returnItem.reason.toLowerCase().includes(searchTerm)
        );
        displayReturns(filtered);
    }

    function showAddReturnModal() {
        document.getElementById('returnForm').reset();
        document.getElementById('invoiceDetails').style.display = 'none';
        document.getElementById('returnItems').innerHTML = '';
        
        const modal = new bootstrap.Modal(document.getElementById('addReturnModal'));
        modal.show();
    }

    async function loadInvoices() {
        const returnType = document.getElementById('returnType').value;
        const invoiceSelect = document.getElementById('originalInvoice');
        
        invoiceSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©</option>';
        
        if (!returnType) return;
        
        try {
            const endpoint = returnType === 'sale' ? '/api/sales' : '/api/purchases';
            const response = await fetch(endpoint);
            if (response.ok) {
                invoices = await response.json();
                invoices.forEach(invoice => {
                    const option = document.createElement('option');
                    option.value = invoice.id;
                    option.textContent = `#${invoice.id} - ${invoice.customer_name || invoice.supplier_name} - ${invoice.final_amount.toFixed(2)} Ø¬.Ù…`;
                    invoiceSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading invoices:', error);
        }
    }

    function loadInvoiceDetails() {
        const invoiceId = document.getElementById('originalInvoice').value;
        if (!invoiceId) {
            document.getElementById('invoiceDetails').style.display = 'none';
            return;
        }
        
        selectedInvoice = invoices.find(inv => inv.id == invoiceId);
        if (!selectedInvoice) return;
        
        const invoiceInfo = document.getElementById('invoiceInfo');
        invoiceInfo.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> #${selectedInvoice.id}</p>
                    <p><strong>${selectedInvoice.customer_name ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ù…ÙˆØ±Ø¯'}:</strong> ${selectedInvoice.customer_name || selectedInvoice.supplier_name}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${selectedInvoice.total_amount.toFixed(2)} Ø¬.Ù…</p>
                    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(selectedInvoice.created_at).toLocaleDateString('ar-EG')}</p>
                </div>
            </div>
        `;
        
        document.getElementById('invoiceDetails').style.display = 'block';
        
        // Load invoice items for return selection
        loadReturnItems();
    }

    function loadReturnItems() {
        // This would load the actual items from the invoice
        // For now, we'll show a simple quantity input
        const returnItems = document.getElementById('returnItems');
        returnItems.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø¯Ø¯Ø©.
            </div>
        `;
        
        document.getElementById('returnAmount').value = selectedInvoice.final_amount;
    }

    async function saveReturn() {
        const form = document.getElementById('returnForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const returnData = {
            type: document.getElementById('returnType').value,
            original_invoice_id: parseInt(document.getElementById('originalInvoice').value),
            amount: parseFloat(document.getElementById('returnAmount').value),
            reason: document.getElementById('returnReason').value,
            notes: document.getElementById('returnNotes').value
        };

        try {
            const response = await fetch('/api/returns', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(returnData)
            });

            const result = await response.json();

            if (result.success) {
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
                bootstrap.Modal.getInstance(document.getElementById('addReturnModal')).hide();
                loadReturns();
                loadStats();
            } else {
                alert('Ø®Ø·Ø£: ' + result.message);
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            console.error('Error saving return:', error);
        }
    }

    function viewReturn(returnId) {
        alert('Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø±Ù‚Ù… #' + returnId);
        // Here you would implement return details view
    }

    function printReturn(returnId) {
        alert('Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø±Ù‚Ù… #' + returnId);
        // Here you would implement printing functionality
    }
</script>
{% endblock %}
