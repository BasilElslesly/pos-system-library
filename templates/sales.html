{% extends "base.html" %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - Ù†Ø¸Ø§Ù… POS{% endblock %}
{% block page_title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª{% endblock %}

{% block extra_css %}
<style>
    .sales-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .search-section {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex: 1;
        max-width: 500px;
    }

    .search-input {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        border: 2px solid #e9ecef;
        font-size: 1rem;
    }

    .sales-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .table {
        margin: 0;
    }

    .table thead th {
        background: var(--primary-color);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f3f4;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .sale-id {
        font-weight: 600;
        color: var(--primary-color);
    }

    .customer-name {
        font-weight: 600;
        color: var(--secondary-color);
    }

    .amount-display {
        font-weight: 600;
        color: var(--success-color);
    }

    .payment-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .payment-cash {
        background: #d4edda;
        color: #155724;
    }

    .payment-credit {
        background: #fff3cd;
        color: #856404;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-paid {
        background: #d4edda;
        color: #155724;
    }

    .status-unpaid {
        background: #f8d7da;
        color: #721c24;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 8px;
    }

    .add-sale-btn {
        background: linear-gradient(45deg, var(--success-color), #58d68d);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .add-sale-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .pagination {
        justify-content: center;
        margin-top: 2rem;
    }

    .page-link {
        border-radius: 8px;
        margin: 0 0.25rem;
        border: 2px solid #e9ecef;
        color: var(--primary-color);
    }

    .page-link:hover {
        background: var(--secondary-color);
        border-color: var(--secondary-color);
        color: white;
    }

    .page-item.active .page-link {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    @media (max-width: 768px) {
        .sales-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        
        .search-section {
            max-width: none;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }

        .stats-cards {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-cards">
    <div class="stat-card">
        <div class="stat-value" id="todaySales">0</div>
        <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="monthSales">0</div>
        <div class="stat-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="totalSales">0</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="pendingPayments">0</div>
        <div class="stat-label">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
    </div>
</div>

<div class="sales-header">
    <div class="search-section">
        <input type="text" class="form-control search-input" id="salesSearch" 
               placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...">
        <button class="btn btn-outline-secondary" onclick="loadSales()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    
    <a href="{{ url_for('pos') }}" class="btn add-sale-btn">
        <i class="fas fa-plus"></i>
        ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    </a>
</div>

<div class="sales-table">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø§Ù„Ø®ØµÙ…</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                    <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="salesTableBody">
                <!-- Sales will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<nav>
    <ul class="pagination" id="pagination">
        <!-- Pagination will be generated here -->
    </ul>
</nav>

<!-- Sale Details Modal -->
<div class="modal fade" id="saleDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="saleDetailsContent">
                <!-- Sale details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                <button type="button" class="btn btn-primary" onclick="printSale()">Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let sales = [];
    let currentPage = 1;
    const itemsPerPage = 10;

    document.addEventListener('DOMContentLoaded', function() {
        loadSales();
        loadStats();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('salesSearch').addEventListener('input', filterSales);
    }

    async function loadSales() {
        try {
            const response = await fetch('/api/sales');
            if (response.ok) {
                sales = await response.json();
                displaySales();
            } else {
                console.error('Error loading sales');
                sales = [];
                displaySales();
            }
        } catch (error) {
            console.error('Error loading sales:', error);
            sales = [];
            displaySales();
        }
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/sales/stats');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('todaySales').textContent = stats.today_sales || '420';
                document.getElementById('monthSales').textContent = stats.month_sales || '12,500';
                document.getElementById('totalSales').textContent = stats.total_sales || '85,300';
                document.getElementById('pendingPayments').textContent = stats.pending_payments || '2,100';
            } else {
                // Show sample stats
                document.getElementById('todaySales').textContent = '420';
                document.getElementById('monthSales').textContent = '12,500';
                document.getElementById('totalSales').textContent = '85,300';
                document.getElementById('pendingPayments').textContent = '2,100';
            }
        } catch (error) {
            console.error('Error loading stats:', error);
            // Show sample stats
            document.getElementById('todaySales').textContent = '420';
            document.getElementById('monthSales').textContent = '12,500';
            document.getElementById('totalSales').textContent = '85,300';
            document.getElementById('pendingPayments').textContent = '2,100';
        }
    }

    function displaySales(filteredSales = null) {
        const salesToShow = filteredSales || sales;
        const tbody = document.getElementById('salesTableBody');
        
        // Calculate pagination
        const totalPages = Math.ceil(salesToShow.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentSales = salesToShow.slice(startIndex, endIndex);
        
        tbody.innerHTML = '';
        
        if (currentSales.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        currentSales.forEach(sale => {
            const date = new Date(sale.created_at).toLocaleDateString('ar-EG');
            const time = new Date(sale.created_at).toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <span class="sale-id">#${sale.id}</span>
                </td>
                <td>
                    <span class="customer-name">${sale.customer_name || 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ'}</span>
                </td>
                <td class="amount-display">${sale.total_amount.toFixed(2)} Ø¬.Ù…</td>
                <td>${sale.discount.toFixed(2)} Ø¬.Ù…</td>
                <td class="amount-display">${sale.final_amount.toFixed(2)} Ø¬.Ù…</td>
                <td>
                    <span class="payment-badge ${sale.payment_method === 'Ù†Ù‚Ø¯ÙŠ' ? 'payment-cash' : 'payment-credit'}">
                        ${sale.payment_method}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${sale.is_paid ? 'status-paid' : 'status-unpaid'}">
                        ${sale.is_paid ? 'Ù…Ø¯ÙÙˆØ¹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}
                    </span>
                </td>
                <td>
                    <div>${date}</div>
                    <small class="text-muted">${time}</small>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewSale(${sale.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="printSale(${sale.id})">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        generatePagination(totalPages);
    }

    function generatePagination(totalPages) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Ø§Ù„ØªØ§Ù„ÙŠ</a>`;
        pagination.appendChild(nextLi);
    }

    function changePage(page) {
        if (page < 1 || page > Math.ceil(sales.length / itemsPerPage)) return;
        currentPage = page;
        displaySales();
    }

    function filterSales() {
        const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
        const filtered = sales.filter(sale => 
            sale.id.toString().includes(searchTerm) ||
            (sale.customer_name && sale.customer_name.toLowerCase().includes(searchTerm)) ||
            sale.payment_method.toLowerCase().includes(searchTerm)
        );
        currentPage = 1;
        displaySales(filtered);
    }

    function viewSale(saleId) {
        const sale = sales.find(s => s.id === saleId);
        if (!sale) return;
        
        const content = document.getElementById('saleDetailsContent');
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h6>
                    <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> #${sale.id}</p>
                    <p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${sale.customer_name || 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ'}</p>
                    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(sale.created_at).toLocaleString('ar-EG')}</p>
                </div>
                <div class="col-md-6">
                    <h6>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹</h6>
                    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${sale.total_amount.toFixed(2)} Ø¬.Ù…</p>
                    <p><strong>Ø§Ù„Ø®ØµÙ…:</strong> ${sale.discount.toFixed(2)} Ø¬.Ù…</p>
                    <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> ${sale.final_amount.toFixed(2)} Ø¬.Ù…</p>
                    <p><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${sale.payment_method}</p>
                    <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${sale.is_paid ? 'Ù…Ø¯ÙÙˆØ¹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}</p>
                </div>
            </div>
        `;
        
        const modal = new bootstrap.Modal(document.getElementById('saleDetailsModal'));
        modal.show();
    }

    function printSale(saleId) {
        if (saleId) {
            alert('Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… #' + saleId);
        } else {
            alert('Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
        }
        // Here you would implement actual printing functionality
    }

    // Real-time updates
    socket.on('sale_created', function(data) {
        loadSales();
        loadStats();
    });
</script>
{% endblock %}
